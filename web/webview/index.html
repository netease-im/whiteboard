<!-- 在web页面模拟客户端通过jsBridge使用白板 -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>白板WebView</title>
    <!-- sha1算法，用于在客户端生成auth。实际开发时，不需要引入下面的脚本，auth应该在服务器生成 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.js"></script>
</head>

<body>
    <div id="app">
        <iframe width="800" height="450" src="./webview/webview_vconsole.html"></iframe>
    </div>
    <script src='./params.js'></script>

    <script type="text/javascript">
        // webview --> 客户端
        window.frames[0].window.NativeFunction = function (msgStr) {
            var msg = JSON.parse(msgStr);
            console.log('native function', msg)

            const params = window.whiteboardParams
            // 模拟原生的收到，webWBWorkerInited 事件后
            switch (msg.action) {
                case 'webPageLoaded':
                    login(params)
                    break
                case 'webJoinWBSucceed':
                    enableDraw(true)
                    setInitColor(params)
                    addVideo()
                    addAudio()
                    break
                case "webJoinWBFailed":
                case "webCreateWBFailed":
                case "webLeaveWB":
                    logout(msg.action)
                    break
                case "webGetAuth":
                    sendAuth(params.appSecret)
                    break
            }
        }

        //客户端 --> webview
        //登录NIM以及白板信令
        function login(params) {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsJoinWB',
                param: {
                    uid: params.uid,
                    channelName: params.channel,
                    appKey: params.appKey,
                    platform: params.platform,
                    record: params.record,
                    debug: params.debug
                }
            }))
        }

        //客户端应该销毁webview
        function logout(action) {
            console.error(`${action}, 客户端此时应该销毁webview`)
        }

        //客户端 --> webview
        //设置是否可以编辑
        function enableDraw(enable) {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsDirectCall',
                param: {
                    target: 'drawPlugin',
                    funcName: 'enableDraw',
                    arg1: enable
                }
            }))
        }

        //非主播端设置一个初始颜色
        function setInitColor(envParams) {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsDirectCall',
                param: {
                    target: 'drawPlugin',
                    funcName: 'setColor',
                    arg1: 'rgb(243,0,0)'
                }
            }))
        }

        function addAudio() {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsDirectCall',
                param: {
                    target: 'toolCollection',
                    funcName: 'addOrSetTool',
                    arg1: {
                        position: 'left',
                        item: {
                            tool: 'video'
                        }
                    }
                }
            }))
        }

        function addAudio() {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsDirectCall',
                param: {
                    target: 'toolCollection',
                    funcName: 'addOrSetTool',
                    arg1: {
                        position: 'bottomRight',
                        item: {
                            tool: 'audio'
                        }
                    }
                }
            }))
        }

        function addVideo() {
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsDirectCall',
                param: {
                    target: 'toolCollection',
                    funcName: 'addOrSetTool',
                    arg1: {
                        position: 'bottomRight',
                        item: {
                            tool: 'video'
                        }
                    }
                }
            }))
        }

        /**
         * 请注意！！！！：
         * SampleCode仅为演示用。实际开发时，请不要将appSerect存在客户端中。
         * 实际开发中，下面函数应该从服务器中获取auth并返回给webview
         */
        function sendAuth(appSecret) {
            const Nonce = 'xxxx'        //随机小于128位的字符串
            const curTime = Math.round((Date.now() / 1000))
            const checksum = sha1(appSecret + Nonce + curTime)
            window.frames[0].window.WebJSBridge(JSON.stringify({
                action: 'jsSendAuth',
                param: {
                    code: 200,
                    nonce: Nonce,
                    checksum: checksum,
                    curTime: curTime
                }
            }))
        }
    </script>

</body>

</html>